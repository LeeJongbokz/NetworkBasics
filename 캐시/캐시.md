
## 7장 캐시

- 웹 캐시는 자주 쓰이는 문서의 사본을 자동으로 보관하는 HTTP 장치임    
  웹 요청이 캐시에 도착했을 때, 캐시된 로컬 사본이 존재한다면,  
  그 문서는 원 서버가 아니라 그 캐시로부터 제공됨.  


- 캐시는 다음과 같은 혜택을 줌  
  (1) 캐시는 불필요한 데이터 전송을 줄여서, 네트워크 요금으로 인한 비용을 줄여줌   
  (2) 캐시는 네트워크 병목을 줄여줌. 대역폭을 늘리지 않고도 페이지를 빨리 불러올 수 있게 됨.  
  (3) 캐시는 원 서버에 대한 요청을 줄여줌. 서버는 부하를 줄일 수 있으며  
      더 빨리 응답할 수 있게 됨  
  (4) 페이지를 먼 곳에서 불러올수록 시간이 많이 걸리는데, 캐시는 거리로 인한 지연을 줄여줌  


- 이 장에서 우리는 
  (1) 어떻게 캐시가 성능을 개선하고 비용을 줄이는지,  
  (2) 어떻게 그 효과를 측정하는지  
  (3) 그 효과를 극대화하기 위해 캐시를 어디에 위치시켜야 하는지  
  (4) 어떻게 HTTP가 캐시된 사본을 신선하게 유지하는지  
  (5) 어떻게 캐시가 다른 캐시나 서버와 상호작용하는지 설명함


### 7.1 불필요한 데이터 전송

- 복수의 클라이언트가 자주 쓰이는 원 서버 페이지에 접근할 때, 
  서버는 같은 문서를 클라이언트들에게 각각 한 번씩 전송하게 됨.  
  똑같은 바이트들이 네트워크를 통해 계속 반복해서 이동함.  
  이 불필요한 데이터 전송은 값비싼 네트워크 대역폭을 잡아먹고, 전송을 느리게 만들며, 웹 서버에 부하를 줌.  
  캐시를 이용하면, 첫 번째 서버 응답은 캐시에 보관됨.  
  캐시된 사본이 뒤이은 요청들에 대한 응답으로 사용될 수 있기 때문에 원 서버가 중복해서 트래픽을 주고받는 낭비가 줄어들게 됨.  


### 7.3 갑작스런 요청 쇄도 

- 캐싱은 갑작스런 요청 쇄도에 대처하기 위해 특히 중요함.  
  갑작스런 사건(뉴스 속보, 스팸 메일, 유명 인사와 관련된 사건 등)으로 인해  
  많은 사람이 거의 동시에 웹 문서에 접근할 때 이런 일이 발생함  
  이 결과로 초래된 불필요한 트래픽 급증은 네트워크와 웹 서버의 심각한 장애를 야기시킴  

- 케네스 스타의 클린턴 미 대통령에 대한 조사에 대해 자세한 내용이 담긴 
  "스타 보고서"가 인터넷을 통해 공개된 1998년 9월 11일,   
  미 하원 웹 서버는 한 시간 동안 3백만 건이 넘는 요청을 받았으며,  
  이는 평소의 50배에 달한 것임.  
  뉴스 웹사이트인 CNN.com은 자신들의 웹 서버가 평균 매초 50,000건이 넘는 요청을 받았다고 보고함. 


### 7.5 적중과 부적중

- 이와 같이 캐시는 유용함. 그러나 캐시가 세상 모든 문서의 사본을 저장하지는 않음.  
  캐시에 요청이 도착했을 때, 만약 그에 대응하는 사본이 있따면 그를 이용해 요청이 처리될 수 있음.  
  이를 캐시 적중(cache hit)이라고 부름.  
  만약 대응하는 사본이 없다면 그냥 원 서버로 전달됨.  
  이를 캐시 부적중(cache miss)라고 부름  


#### 7.5.2 적중률  

- 캐시가 요청을 처리하는 비율을 캐시 적중률(혹은 캐시 적중비), 혹은 문서 적중률(혹은 문서 적중비)이라고 부르기도 함
  적중률은 0에서 1까지의 값으로 되어 있지만, 흔히 퍼센트로 표현되기도 함.  
  0%는 모든 요청이 캐시 부적중임을, 100%는 모든 요청이 캐시 적중임을 의미함  
  
- 캐시 관리자는 캐시 적중률이 100%에 근접하게 되는 것을 좋아함  
  실제 적중률은 캐시가 얼마나 큰지, 캐시 사용자들의 관심사가 얼마나 비슷한지,  
  캐시된 데이터가 얼마나 자주 변경되거나 개인화되는지,  
  캐시가 어떻게 설정되어 있는지에 달려 있음  
  
- 적중률은 예측하기 어려운 것으로 악명이 높지만  
  오늘날 적중률 40%면 웹 캐시로 괜찮은 편임  
  다행인 사실은, 보통 크기의 캐시라도 충분한 분량의 자주 쓰이눈 문서들을 보관하여  
  상당히 트래픽을 줄이고 성능을 개선할 수 있다는 점임.  
  캐시는 유용한 콘텐츠가 캐시 안에 머무르도록 보장하기 위해 노력함.
  
  

### 7.7 캐시 처리 단계

- 오늘날 상용 프락시 캐시는 꽤 복잡함.  
  매우 고성능이면서도 HTTP와 그 외 다른 기술의 고급 기능을 지원하도록 만들어졌음.  
  그러나 몇 군데 미묘한 구석이 있긴 하지만,  
  웹 캐시의 기본적인 동작은 대개 단순함.  
  HTTP GET 메시지 하나를 처리하는 기본적인 캐시 처리 절차는 일곱 단계로 이루어져 있음.  
  
- (1) 요청 받기 - 캐시는 네트워크로부터 도착한 요청 메시지를 읽음  
  (2) 파싱 - 캐시는 메시지를 파싱하여 URL과 헤더들을 추출함  
  (3) 검색 - 캐시는 로컬 복사본이 있는지 검사하고, 사본이 없다면 사본을 받아옴(그리고 로컬에 저장함)   
  (4) 신선도 검사 - 캐시는 캐시된 사본이 충분히 신선한지 검사하고, 신선하지 않다면 변경사항이 있는지 서버에게 물어봄  
  (5) 응답 생성 - 캐시는 새로운 헤더와 캐시된 본문으로 응답 메시지를 만듦    
  (6) 발송 - 캐시는 네트워크를 통해 응답을 클라이언트에게 돌려줌     
  (7) 로깅 - 선택적으로, 캐시는 로그파일에 트랜잭션에 대해 서술한 로그 하나를 남김     
  
  
  
#### 7.7.1 단계 1: 요청 받기

- 단계 1에서, 캐시는 네트워크 커넥션에서의 활동을 감지하고, 들어오는 데이터를 읽어들임.  
  고성능 캐시는 여러 개의 들어오는 커넥션드르로부터 데이터를 동시에 읽어들이고,  
  메시지 전체가 도착하기 전에 트랜잭션 처리를 시작함.  
  
  
#### 7.7.2 단계 2: 파싱

- 다음으로, 캐시는 요청 메시지를 여러 부분으로 파싱하여 헤더 부분을 조작하기 쉬운 자료 구조에 담음  
  이는 캐싱 소프트웨어가 헤더 필드를 처리하고 조작하기 쉽게 만들어줌.  
  

#### 7.7.3 단계 3: 검색

- 단계 3에서, 캐시는 URL을 알아내고 그에 해당하는 로컬 사본이 있는지 검사함  
  로컬 복사본은 메모리에 저장되어 있을 수도 있고,  
  아니면 디스크나 심지어 근처의 다른 컴퓨터에 있을 수도 있음.  
  전문적인 수준의 캐시는 객체를 로컬 캐시에서 가져올 수 있는지 판단하기 위해  
  빠른 알고리즘을 사용함  
  만약 문서를 로컬에서 가져올 수 없다면,  
  캐시는 상황이나 설정에 따라서 그것을 원 서버나 부모 프락시에 가져오거나 혹은 실패를 반환함.  
  
  캐시된 객체는 서버 응답 본문과 원 서버 응답 헤더를 포함하고 있으므로,   
  캐시 적중 동안 올바른 서버 헤더가 반환될 수 있음.  
  캐시된 객체는 또한 객체가 얼마나 오랫동안 캐시에 머무르고 있었는지를 알려주는 기록이나  
  얼마나 자주 사용되었는지 등에 대한 몇몇 메타데이터를 포함함.  
  
  
#### 7.7.4 단계 4: 신선도 검사

- HTTP는 캐시가 일정 기간 동안 서버 문서의 사본을 보유할 수 있도록 해줌  
  이 기간 동안, 문서는 '신선'한 것으로 간주되고 캐시는 서버와의 접촉 없이  
  이 문서를 제공할 수 있음.  
  그러나 일단 캐시된 사본을 신선도 한계를 넘을 정도로 너무 오래 갖고 있었다면  
  그 객체는 '신선하지 않은' 것으로 간주되며,  
  캐시는 그 문서를 제공하기 전에 문서에 어떤 변경이 있었는지 검사하기 위해  
  서버와 재검사를 해야 함.  
  
- HTTP의 신선도 검사 규칙은 매우 복잡한데, 캐시 제품들이 지원하는 많은 수의 설정 옵션과  
  비 HTTP 신선도 표준과의 상호작용은 상황을 더 복잡하게 만들었음  
  

#### 7.7.5 단계 5: 응답 생성

- 우리는 캐시된 응답을 원 서버에서 온 것처럼 보이게 하고 싶기 때문에,  
  캐시는 캐시된 서버 응답 헤더를 토대로 응답 헤더를 생성함  
  이 기저 헤더들은 캐시에 의해 수정되고 늘어남  
  
- 캐시는 클라이언트에 맞게 이 헤더를 조정해야 하는 책임이 있음.  
  예를 들어, 클라이언트가 HTTP/1.1 응답을 기대하는 상황에서  
  서버가 HTTP/1.0 응답(혹은 HTTP 0.9응답)을 반환했다면,  
  캐시는 반드시 헤더를 적절하게 번역해야 함.  
  캐시는 또한 캐시 신선도 정보를 삽입하며(Cache-Control, Age, Expires 헤더),  
  또 요청이 프락시 캐시를 거쳐갔음을 알려주기 위해 종종 Via 헤더를 포함시킴  
  
- 캐시가 Date 헤더를 조정해서는 안 된다는 것에 주의함.  
  Date 헤더는 그 객체가 원 서버에서 최초로 생겨난 일시를 표현하는 것임.  
  
 
#### 7.7.6 단계 6: 전송

- 일단 응답 헤더가 준비되면, 캐시는 응답을 클라이언트에게 돌려줌.  
  모든 프락시 서버들과 마찬가지로, 프락시 캐시는 클라이언트와의 커넥션을 유지할 필요가 있음.  
  고성능 캐시는 종종 로컬 저장장치와 네트워크 I/O 버퍼 사이에서 문서의 콘텐츠 복사를 피함으로써  
  데이터를 효과적으로 전송하기 위해 노력함  
  

#### 7.7.7 단계 7: 로깅

- 대부분의 캐시는 로그 파일과 캐시 사용에 대한 통계를 유지함.  
  각 캐시 트랜잭션이 완료된 후, 캐시는 통계 캐시 적중과 부적중 횟수에 대한 통계를 갱신하고  
  로그 파일에 요청 종류, URL, 그리고 무엇이 일어났는지를 알려주는 항목을 추가함.  
 
- 가장 많이 쓰이는 캐시 로그 포맷은 스쿼드 로그 포맷과 넷스케이프 확장 공용 로그 포맷이지만,  
  많은 캐시 제품이 커스텀 로그파일을 허용 함  
  
  
  
  
  
  
  
  

 
